<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N2B 정부지원사업 매칭 v3.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <h1 class="text-2xl font-bold">🚀 N2B 정부지원사업 매칭</h1>
            <p class="text-purple-100 mt-1">v3.1 - 지역 필터링 지원</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- 모드 선택 -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4">
            <h2 class="text-lg font-bold text-gray-800 mb-3">🎯 시작하기</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setMode('demo')" id="demoBtnMode" 
                        class="p-4 border-2 border-purple-500 bg-purple-50 rounded-xl text-center hover:bg-purple-100 transition">
                    <div class="text-2xl mb-2">🎮</div>
                    <div class="font-bold text-purple-700">데모 체험</div>
                    <div class="text-xs text-gray-500">API 키 없이 바로 체험</div>
                </button>
                <button onclick="setMode('real')" id="realBtnMode"
                        class="p-4 border-2 border-gray-300 rounded-xl text-center hover:bg-gray-50 transition">
                    <div class="text-2xl mb-2">🔬</div>
                    <div class="font-bold text-gray-700">실제 분석</div>
                    <div class="text-xs text-gray-500">본인 API 키로 실시간 검색</div>
                </button>
            </div>
        </div>

        <!-- API Key (실제 분석용) -->
        <div id="apiKeySection" class="hidden bg-white rounded-xl shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">🔑 Anthropic API Key</label>
            <input type="password" id="apiKey" class="w-full px-4 py-3 border rounded-lg" placeholder="sk-ant-api...">
            <p class="text-xs text-gray-500 mt-1">API 키는 <a href="https://console.anthropic.com" target="_blank" class="text-purple-600 underline">Anthropic Console</a>에서 발급</p>
        </div>

        <!-- 지역 선택 -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">📍 지역 선택</label>
            <select id="regionSelect" class="w-full px-4 py-3 border rounded-lg bg-white">
                <option value="전체">🇰🇷 전체 (전국)</option>
                <option value="서울">서울특별시</option>
                <option value="부산">부산광역시</option>
                <option value="대구">대구광역시</option>
                <option value="인천">인천광역시</option>
                <option value="광주">광주광역시</option>
                <option value="대전">대전광역시</option>
                <option value="울산">울산광역시</option>
                <option value="세종">세종특별자치시</option>
                <option value="경기">경기도</option>
                <option value="강원">강원특별자치도</option>
                <option value="충북">충청북도</option>
                <option value="충남">충청남도</option>
                <option value="전북">전북특별자치도</option>
                <option value="전남">전라남도</option>
                <option value="경북">경상북도</option>
                <option value="경남">경상남도</option>
                <option value="제주">제주특별자치도</option>
            </select>
        </div>

        <!-- 사업계획 입력 -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">📝 사업계획 입력</label>
            <p class="text-xs text-gray-500 mb-2">샘플을 선택하거나 직접 입력하세요:</p>
            <div class="flex flex-wrap gap-2 mb-3">
                <button onclick="loadSample('health')" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm hover:bg-purple-200">🏥 AI 헬스케어</button>
                <button onclick="loadSample('farm')" class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm hover:bg-green-200">🌱 스마트팜</button>
                <button onclick="loadSample('recycle')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm hover:bg-blue-200">♻️ 폐플라스틱 재활용</button>
            </div>
            <textarea id="proposalText" rows="4" class="w-full px-4 py-3 border rounded-lg" placeholder="사업 아이디어를 입력하세요..."></textarea>
        </div>

        <!-- 분석 버튼 -->
        <button onclick="runAnalysis()" class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-lg mb-6 hover:opacity-90 transition">
            🔍 N2B 분석 및 매칭 시작
        </button>

        <!-- 로딩 -->
        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent"></div>
            <p class="mt-4 text-gray-600" id="loadingText">분석 중...</p>
        </div>

        <!-- N2B 결과 -->
        <div id="n2bResult" class="hidden bg-white rounded-xl shadow-md p-4 mb-4">
            <h2 class="text-lg font-bold text-gray-800 mb-4">📊 N2B 분석 결과</h2>
            <div class="space-y-3">
                <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                    <h3 class="font-bold text-red-700 text-sm">N (Not) - 문제점</h3>
                    <p id="resultN" class="text-gray-700 text-sm mt-1"></p>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                    <h3 class="font-bold text-blue-700 text-sm">B (But) - 솔루션</h3>
                    <p id="resultB" class="text-gray-700 text-sm mt-1"></p>
                </div>
                <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                    <h3 class="font-bold text-green-700 text-sm">C (Because) - 근거</h3>
                    <p id="resultC" class="text-gray-700 text-sm mt-1"></p>
                </div>
                <div class="bg-purple-50 p-3 rounded">
                    <h3 class="font-bold text-purple-700 text-sm">🏷️ 키워드</h3>
                    <div id="resultKeywords" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
            </div>
        </div>

        <!-- 매칭 결과 -->
        <div id="matchResult" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800">🎯 매칭된 지원사업</h2>
                <span id="regionBadge" class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm"></span>
            </div>
            <div id="programList" class="space-y-4"></div>
        </div>
    </main>

    <footer class="text-center py-4 text-gray-500 text-sm">
        © 2025 N2B Framework by Brian Yoo
    </footer>

    <script>
        let currentMode = 'demo';
        const API_BASE = 'https://n2b-backend.onrender.com';

        // 샘플 데이터
        const samples = {
            health: {
                text: 'AI 기반 개인 맞춤형 건강관리 플랫폼을 개발합니다. 웨어러블 기기 데이터와 건강검진 결과를 분석하여 질병 예방 및 건강 개선 솔루션을 제공합니다.',
                demo: {
                    N: "현재 건강관리 서비스는 개인화되지 않고, 사후 치료 중심이며, 데이터 활용이 제한적입니다.",
                    B: "AI가 개인별 건강 데이터를 분석하여 맞춤형 예방 솔루션을 제공하는 플랫폼을 구축합니다.",
                    C: "예방의료 시장이 급성장 중이며, 의료비 절감과 삶의 질 향상에 기여할 수 있습니다.",
                    keywords: ["AI헬스케어", "디지털헬스", "예방의료"],
                    programs: [
                        { name: "2025년 AI 의료 실증사업", organization: "과학기술정보통신부", region: "전국", deadline: "2025.03.31", amount: "최대 5억원", matchScore: 92, matchReason: "AI 기반 헬스케어 솔루션과 정확히 매칭", url: "https://www.bizinfo.go.kr" },
                        { name: "디지털헬스케어 스타트업 지원", organization: "보건복지부", region: "전국", deadline: "2025.02.28", amount: "최대 3억원", matchScore: 88, matchReason: "건강관리 플랫폼 개발 지원", url: "https://www.bizinfo.go.kr" },
                        { name: "바이오헬스 R&D 지원사업", organization: "중소벤처기업부", region: "전국", deadline: "2025.04.15", amount: "최대 2억원", matchScore: 78, matchReason: "헬스케어 기술 R&D 지원", url: "https://www.bizinfo.go.kr" }
                    ]
                }
            },
            farm: {
                text: '저는 IoT 센서와 AI를 결합하여 토양, 기후, 작물 상태를 실시간 모니터링하고 최적의 재배 환경을 자동 제어하는 스마트팜 솔루션을 개발합니다.',
                demo: {
                    N: "기존 농업은 기후 변화에 취약하고 노동력 의존도가 높으며, 생산성 예측이 어렵습니다.",
                    B: "IoT 센서 기반 스마트팜으로 자동화된 재배환경 제어 및 AI 예측 시스템을 구축합니다.",
                    C: "농업 생산성 30% 향상, 인건비 절감, 기후 리스크 최소화가 가능합니다.",
                    keywords: ["스마트팜", "IoT", "AI농업"],
                    programs: [
                        { name: "2025년 스마트팜 확산사업", organization: "농림축산식품부", region: "전국", deadline: "2025.03.15", amount: "최대 3억원", matchScore: 95, matchReason: "스마트팜 기술 개발과 직접 연관", url: "https://www.bizinfo.go.kr" },
                        { name: "농식품 ICT 융복합 지원사업", organization: "농림축산식품부", region: "전국", deadline: "2025.02.20", amount: "최대 2억원", matchScore: 90, matchReason: "IoT 기반 농업 기술 지원", url: "https://www.bizinfo.go.kr" },
                        { name: "청년농업인 창업지원", organization: "농림축산식품부", region: "전국", deadline: "2025.04.30", amount: "최대 1억원", matchScore: 72, matchReason: "농업 분야 창업 지원", url: "https://www.bizinfo.go.kr" }
                    ]
                }
            },
            recycle: {
                text: 'AI 기반 폐플라스틱 자동 분류 시스템을 개발하여 재활용률을 높이고 환경오염을 줄이는 솔루션을 제공합니다.',
                demo: {
                    N: "현재 폐플라스틱 분류는 수작업 의존도가 높고, 재활용률이 낮으며, 환경오염이 심각합니다.",
                    B: "AI 비전 기술로 폐플라스틱을 자동 분류하여 재활용 효율을 극대화합니다.",
                    C: "ESG 경영 트렌드와 정부 탄소중립 정책에 부합하며, 재활용 산업 성장이 예상됩니다.",
                    keywords: ["재활용", "AI분류", "탄소중립"],
                    programs: [
                        { name: "2025년 탄소중립 기술개발 사업", organization: "환경부", region: "전국", deadline: "2025.03.20", amount: "최대 5억원", matchScore: 94, matchReason: "탄소중립 및 재활용 기술과 직접 연관", url: "https://www.bizinfo.go.kr" },
                        { name: "순환경제 혁신기업 지원", organization: "환경부", region: "전국", deadline: "2025.02.28", amount: "최대 3억원", matchScore: 91, matchReason: "재활용 기술 혁신 지원", url: "https://www.bizinfo.go.kr" },
                        { name: "AI 제조혁신 지원사업", organization: "중소벤처기업부", region: "전국", deadline: "2025.04.10", amount: "최대 2억원", matchScore: 75, matchReason: "AI 기반 제조/분류 기술 지원", url: "https://www.bizinfo.go.kr" }
                    ]
                }
            }
        };

        // 모드 설정
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('demoBtnMode').classList.toggle('border-purple-500', mode === 'demo');
            document.getElementById('demoBtnMode').classList.toggle('bg-purple-50', mode === 'demo');
            document.getElementById('demoBtnMode').classList.toggle('border-gray-300', mode !== 'demo');
            document.getElementById('realBtnMode').classList.toggle('border-purple-500', mode === 'real');
            document.getElementById('realBtnMode').classList.toggle('bg-purple-50', mode === 'real');
            document.getElementById('realBtnMode').classList.toggle('border-gray-300', mode !== 'real');
            document.getElementById('apiKeySection').classList.toggle('hidden', mode === 'demo');
        }

        // 샘플 로드
        function loadSample(key) {
            document.getElementById('proposalText').value = samples[key]?.text || '';
        }

        // 분석 실행
        async function runAnalysis() {
            const proposalText = document.getElementById('proposalText').value;
            if (!proposalText) {
                alert('사업계획서를 입력해주세요.');
                return;
            }

            if (currentMode === 'demo') {
                runDemoAnalysis(proposalText);
            } else {
                await runRealAnalysis(proposalText);
            }
        }

        // 데모 분석
        function runDemoAnalysis(proposalText) {
            showLoading(true, '데모 결과 로딩 중...');

            // 어떤 샘플과 매칭되는지 찾기
            let matchedSample = null;
            for (const key in samples) {
                if (proposalText.includes(samples[key].text.substring(0, 20)) || 
                    proposalText.toLowerCase().includes(key)) {
                    matchedSample = samples[key].demo;
                    break;
                }
            }

            // 매칭되는 샘플 없으면 기본값
            if (!matchedSample) {
                matchedSample = samples.farm.demo;
            }

            setTimeout(() => {
                displayResults(matchedSample);
                showLoading(false);
            }, 1500);
        }

        // 실제 분석
        async function runRealAnalysis(proposalText) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('API Key를 입력해주세요.');
                return;
            }

            showLoading(true, 'AI가 분석 중...');

            try {
                // N2B 분석
                const analyzeRes = await fetch(`${API_BASE}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, proposalText })
                });
                
                if (!analyzeRes.ok) {
                    const err = await analyzeRes.json();
                    throw new Error(err.detail || '분석 실패');
                }

                const n2bResult = await analyzeRes.json();

                // 매칭
                const region = document.getElementById('regionSelect').value;
                const matchRes = await fetch(`${API_BASE}/match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, n2bAnalysis: n2bResult, region })
                });

                const matchResult = await matchRes.json();

                displayResults({
                    ...n2bResult,
                    programs: matchResult.programs || []
                });

            } catch (error) {
                alert('오류: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // 결과 표시
        function displayResults(data) {
            const region = document.getElementById('regionSelect').value;

            document.getElementById('resultN').textContent = data.N || '';
            document.getElementById('resultB').textContent = data.B || '';
            document.getElementById('resultC').textContent = data.C || '';

            const keywords = data.keywords || [];
            document.getElementById('resultKeywords').innerHTML = keywords.map(k =>
                `<span class="px-3 py-1 bg-purple-200 text-purple-800 rounded-full text-sm">${k}</span>`
            ).join('');

            document.getElementById('n2bResult').classList.remove('hidden');

            // 매칭 결과
            document.getElementById('regionBadge').textContent = `📍 ${region === '전체' ? '전국' : region}`;
            
            const programs = data.programs || [];
            const listDiv = document.getElementById('programList');

            if (programs.length > 0) {
                listDiv.innerHTML = programs.map(p => `
                    <div class="bg-white rounded-xl shadow-md p-4 card-hover transition">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">${p.region || region}</span>
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">매칭 ${p.matchScore || 85}%</span>
                        </div>
                        <h3 class="font-bold text-gray-800">${p.name || '사업명'}</h3>
                        <p class="text-gray-600 text-sm">🏢 ${p.organization || '-'}</p>
                        <p class="text-gray-600 text-sm">📅 마감: ${p.deadline || '-'}</p>
                        <p class="text-gray-600 text-sm">💰 ${p.amount || '-'}</p>
                        <p class="text-purple-600 text-sm mt-2">💡 ${p.matchReason || ''}</p>
                        ${p.url ? `<a href="${p.url}" target="_blank" class="inline-block mt-2 px-4 py-2 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600">상세보기 →</a>` : ''}
                    </div>
                `).join('');
            } else {
                listDiv.innerHTML = `<div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-center">
                    <p class="text-yellow-700">매칭된 지원사업이 없습니다.</p>
                </div>`;
            }

            document.getElementById('matchResult').classList.remove('hidden');
        }

        function showLoading(show, text = '분석 중...') {
            document.getElementById('loading').classList.toggle('hidden', !show);
            document.getElementById('loadingText').textContent = text;
        }

        // 초기화
        setMode('demo');
    </script>
</body>
</html>
